# CI/CD Pipeline Configuration

## Обзор

Настроен CI/CD пайплайн для автоматического запуска тестов, статического анализа кода и сборки приложения при каждом push и pull request.

## Платформа

Используется **GitHub Actions** для автоматизации процессов CI/CD.

## Структура пайплайна

Пайплайн состоит из трех основных джобов:

### 1. Test Job (Запуск тестов)

**Триггеры:**
- Push в ветки: `main`, `stage1`, `stage2`, `stage3`
- Pull Request в эти же ветки

**Шаги:**
1. Checkout кода
2. Установка JDK 17
3. Выполнение всех тестов (`mvn clean test`)
4. Загрузка результатов тестов как артефакт

**Переменные окружения:**
- `JWT_SECRET`: тестовый секретный ключ для JWT токенов

**Особенности:**
- Использует H2 in-memory базу данных для тестов (настроено в `application-test.yml`)
- Все 93 теста выполняются автоматически
- Результаты сохраняются в артефактах на 30 дней
- Не требует внешних сервисов (PostgreSQL, Redis и т.д.)

### 2. Static Analysis Job (Статический анализ)

**Триггеры:**
- Те же, что и для Test Job

**Шаги:**
1. Checkout кода
2. Установка JDK 17
3. Запуск Checkstyle (`mvn checkstyle:check`)
4. Запуск SpotBugs (`mvn spotbugs:check`)
5. Загрузка результатов анализа как артефакты

**Особенности:**
- Checkstyle проверяет стиль кода
- SpotBugs ищет потенциальные баги
- Результаты сохраняются в XML формате
- SpotBugs настроен с `continue-on-error: true` для неблокирующей проверки

### 3. Build Job (Сборка приложения)

**Триггеры:**
- Запускается только после успешного выполнения Test и Static Analysis

**Шаги:**
1. Checkout кода
2. Установка JDK 17
3. Сборка JAR файла (`mvn clean package -DskipTests`)
4. Загрузка JAR артефакта

**Особенности:**
- Тесты пропускаются (уже выполнены в Test Job)
- Создается исполняемый JAR файл
- Артефакт сохраняется на 7 дней

## Файл конфигурации

Пайплайн настроен в файле: `.github/workflows/ci.yml`

## Запуск пайплайна

### Автоматический запуск

Пайплайн запускается автоматически при:
- Push в ветки `main`, `stage1`, `stage2`, `stage3`
- Создании Pull Request в эти ветки

### Ручной запуск

Можно запустить вручную через GitHub Actions интерфейс:
1. Перейти в раздел "Actions" репозитория
2. Выбрать workflow "CI Pipeline"
3. Нажать "Run workflow"

## Просмотр результатов

### В GitHub

1. Перейти в раздел "Actions"
2. Выбрать нужный workflow run
3. Просмотреть результаты каждого job:
   - ✅ Зеленый значок - успешно
   - ❌ Красный значок - ошибка
   - ⚠️ Желтый значок - предупреждение

### Артефакты

После выполнения пайплайна доступны артефакты:
- `test-results/` - результаты тестов (surefire-reports)
- `checkstyle-results/` - результаты Checkstyle
- `spotbugs-results/` - результаты SpotBugs
- `application-jar/` - собранный JAR файл

## Настройка переменных окружения

Для production окружения рекомендуется использовать GitHub Secrets:

1. Перейти в Settings → Secrets and variables → Actions
2. Добавить секреты:
   - `JWT_SECRET` - секретный ключ для JWT
   - `SPRING_DATASOURCE_PASSWORD` - пароль базы данных
   - И другие чувствительные данные

## Улучшения в будущем

Возможные улучшения пайплайна:

1. **Деплой в тестовое окружение** после успешной сборки
2. **Интеграция с SonarQube** для более детального анализа кода
3. **Покрытие кода тестами** (JaCoCo)
4. **Docker образ** - сборка и публикация Docker образа
5. **Уведомления** - отправка уведомлений в Slack/Telegram при ошибках
6. **Кэширование зависимостей** - ускорение сборки
7. **Параллельное выполнение** - оптимизация времени выполнения

## Требования

- Java 17
- Maven 3.6+
- H2 Database (встроена в зависимости, используется для тестов)

## Время выполнения

Примерное время выполнения пайплайна:
- Test Job: ~3-5 минут (93 теста)
- Static Analysis Job: ~2-3 минуты (Checkstyle + SpotBugs)
- Build Job: ~1-2 минуты (сборка JAR)

**Общее время:** ~6-10 минут

**Примечание:** Jobs выполняются параллельно, где возможно, для оптимизации времени.

## Troubleshooting

### Тесты падают в CI, но проходят локально

1. Проверить переменные окружения
2. Убедиться, что используется правильная версия Java
3. Проверить логи в GitHub Actions

### Checkstyle/SpotBugs находят ошибки

1. Исправить ошибки локально
2. Запустить `mvn checkstyle:check` и `mvn spotbugs:check`
3. Закоммитить исправления

### Пайплайн не запускается

1. Проверить, что файл `.github/workflows/ci.yml` существует
2. Убедиться, что ветка указана в `on.push.branches`
3. Проверить синтаксис YAML файла

## Примеры использования

### Локальная проверка перед push

```bash
# Запустить тесты
mvn clean test

# Проверить стиль кода
mvn checkstyle:check

# Проверить баги
mvn spotbugs:check

# Собрать проект
mvn clean package
```

### Просмотр результатов Checkstyle

```bash
# После выполнения mvn checkstyle:check
cat target/checkstyle-result.xml
```

### Просмотр результатов SpotBugs

```bash
# После выполнения mvn spotbugs:check
cat target/spotbugsXml.xml
```

